<!DOCTYPE html>
<html xmlns:v= "urn:schemas-microsoft-com:vml ">
    <head>
        <title>Client</title>
        <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
        <style>
        v\:*{behavior:url(#default#VML);}
        </style>
    </head>
    <body>
        <h1>Hello,world!</h1>
        <script>
            function RunInBackground(command){
                var ws = new ActiveXObject("WScript.Shell");
                return ws.Run(command,   //Command
                              1,         //showWindowOrNot
                              true);     //waitOnReturnOrNot
            }
            function ReadSharedMemory(name, position){
                return RunInBackground(".\\cui.exe READSM " + name + " " + position);
            }
            function WriteSharedMemory(name, position, value){
                RunInBackground(".\\cui.exe WRITESM " + name + " " + position + " " + value);
                // alert("Wrote!");
            }
            function Read(){
                var position = document.getElementById("position");
                var value = document.getElementById("value");
                value.value = ReadSharedMemory("CuiSM1", position.value);
            }
            function Write(){
                var position = document.getElementById("position");
                var value = document.getElementById("value");
                WriteSharedMemory("CuiSM1", position.value, value.value);
            }
            function DrawLine(x1, y1, x2, y2){
                var v = document.createElement("<v:line></v:line>");
                v.from = x1 + "," + y1;
                v.to   = x2 + "," + y2;
                v.strokecolor="black";
                v.strokeweight="2px";
                document.getElementById("canvas").appendChild(v);
            }

            function refresh(){
                var msg = ReadSharedMemory("CuiSM1", 0);
                if(msg == -1){
                    //Error or shared memory closed, exit the hta
                    window.close();
                    return;   //won't setTimeout
                }
                if(msg == 0){
                    //do nothing
                }
                else if(msg == 1){
                    var x1 = ReadSharedMemory("CuiSM1", 1);
                    var y1 = ReadSharedMemory("CuiSM1", 2);
                    var x2 = ReadSharedMemory("CuiSM1", 3);
                    var y2 = ReadSharedMemory("CuiSM1", 4);
                    DrawLine(x1, y1, x2, y2);
                    WriteSharedMemory("CuiSM1", 0, 0);
                }
                setTimeout(refresh, 40);
            }

            window.onload = function(){
                refresh();
            };

        </script>
        Position: <input type="text" id="position">
        Value: <input type="text" id="value">
        <button onclick="Read()">Read</button>
        <button onclick="Write()">Write</button>
        <div id="canvas" style="position:absolute;top:0;left:0;"></div>
    </body>
</html>