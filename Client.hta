<!DOCTYPE html>
<html xmlns:v= "urn:schemas-microsoft-com:vml ">
    <head>
        <title>Client</title>
        <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" charset="utf-8" />
        <style>
        v\:*{behavior:url(#default#VML);}
        </style>
    </head>
    <body>
        <div id="canvas" style="position:absolute;top:0;left:0;"></div>
        <script>

            /*
            ** Tool Functions
            */

            function RunInBackground(command){
                var ws = new ActiveXObject("WScript.Shell");
                return ws.Run(command,   //Command
                              0,         //showWindowOrNot
                              true);     //waitOnReturnOrNot
            }

            function ReadSharedMemory(name, position){
                return RunInBackground(".\\cui.exe READSM " + name + " " + position);
            }

            function WriteSharedMemory(name, position, value){
                RunInBackground(".\\cui.exe WRITESM " + name + " " + position + " " + value);
            }

            /*
            ** Drawing Functions
            */

            function DrawLine(x1, y1, x2, y2){
                var v = document.createElement("<v:line></v:line>");
                v.from = x1 + "," + y1;
                v.to   = x2 + "," + y2;
                v.strokecolor="black";
                v.strokeweight="2px";
                document.getElementById("canvas").appendChild(v);
            }

            /*
            ** Main Functions
            */

            var continueRefreshOrNot = true;
            function refresh(){
                if(continueRefreshOrNot == false){
                    return;   //Won't refresh and won't setTimeout
                }

                var msg = ReadSharedMemory("CuiSM1", 0);

                if(msg == 0){
                    //Do nothing
                }
                else if(msg == -1){
                    //Error or shared memory closed, exit the hta
                    window.close();
                    return;   //Won't refresh and won't setTimeout
                }
                else if(msg == -2){
                    //HeartBeat Testing
                    WriteSharedMemory("CuiSM1", 0, 0);
                }
                else if(msg == 1){
                    //DrawLine()
                    var x1 = ReadSharedMemory("CuiSM1", 1);
                    var y1 = ReadSharedMemory("CuiSM1", 2);
                    var x2 = ReadSharedMemory("CuiSM1", 3);
                    var y2 = ReadSharedMemory("CuiSM1", 4);
                    DrawLine(x1, y1, x2, y2);
                    WriteSharedMemory("CuiSM1", 0, 0);
                }
                setTimeout(refresh, 40);
            }

            window.onload = function(){
                setTimeout(refresh, 40);
            };


            
            function OnClose()
            {
                if(event.clientX>document.body.clientWidth&&event.clientY<0||event.altKey)
                {
                    continueRefreshOrNot = false;
                    // return "message";
                }
            }

            window.onbeforeunload=OnClose;

        </script>
    </body>
</html>